---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

steps:
- name: submodules
  image: nephatrine/nxbuilder:alpine
  commands:
  - sudo chown -R packager .
  - git submodule update --init --recursive
- name: build-alpine
  image: nephatrine/nxbuilder:alpine
  commands:
  - sudo apk add curl-dev
  - make
  - tar -czvf q2admin-nxmod_x86_64-alpine-linux-musl.tar.gz -C release game.so
  - tar -czvf q2admin-nxmod_noarch.tar.gz q2*.txt q2*.json
  depends_on:
  - submodules
- name: publish-web
  image: vividboarder/drone-webdav
  settings:
    file: q2admin-nxmod_{x86_64-alpine-linux-musl,noarch}.tar.gz
    destination: https://files.nephatrine.net/archives/
    username:
      from_secret: webdav-user
    password:
      from_secret: webdav-pass
  depends_on:
  - build-alpine
  when:
    event:
      exclude:
      - pull_request
- name: publish-gitea
  image: plugins/gitea-release
  settings:
    api_key:
      from_secret: gitea-api
    base_url: https://code.nephatrine.net
    files:
    - q2admin-nxmod_x86_64-alpine-linux-musl.tar.gz
    - q2admin-nxmod_noarch.tar.gz
  depends_on:
  - build-alpine
  when:
    event:
    - tag

---
kind: pipeline
name: notify

steps:
- name: notify-status
  image: appleboy/drone-discord
  failure: ignore
  settings:
    avatar_url: https://nephatrine.net/images/buttons/drone-ci.png
    message: "Build of **[{{repo.name}}:{{commit.branch}}](<https://code.nephatrine.net/nephatrine/{{repo.name}}/src/branch/{{commit.branch}}>)** returned [{{build.status}}](<{{build.link}}>)."
    username: DroneCI
    webhook_id:
      from_secret: wh-quake2-id
    webhook_token:
      from_secret: wh-quake2-tok

depends_on:
- default

trigger:
  status:
  - success
  - failure

---
kind: signature
hmac: 7b0b7a5755e7b407ac9d0504d8cb472a4d54cc52df7343d184a6d19950ac81a6

...
